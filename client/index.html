<html>
	<head>
		<title>chat io</title>
		<meta charset="utf-8">
	    <meta http-equiv="X-UA-Compatible" content="IE=edge">
	    <meta name="viewport" content="width=device-width, initial-scale=1">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
		<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
		<link rel="stylesheet" type="text/css" href="css/style.css">

		<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/annyang/2.6.0/annyang.min.js"></script>-->
		<script src="/socket.io/socket.io.js"></script>
		<script type="text/javascript" src="js/cookie.js"></script>
		<script src="js/easyNotify.js"></script>
		<script src="js/custom.js"></script>
	</head>
	<body>
	    <form id="form1" runat="server">
	        <input type='file' id="imgInp" />
	        <img id="blah" src="#" alt="your image" />
	    </form>
		<div class="container">
			<div id="userFormAre" class="row">
				<div class="col-md-12">
					<form id="userForm">
						<div class="userimgwrapper">
							 <img src="img/man.jpg" class="img-responsive">
						</div>
						<div class="formgroup">
							<label for="username">Enter user</label>
							<input name="" id="username" class="form-control" >
							<span>Press Enter key to continue</span>
							<!-- <input type="submit" class="btn btn-primary" value="Login"> -->
						</div>
					</form>
				</div>
			</div>
			<div id="messageAre" class="row">
				<div class="leftside">
					<header>
						<span>Online Users</span>
					</header>
					<div class="onlineuserswrapper">
						<div class="sinrow">
							<div class="userImg">
								<img src="img/man.jpg" class="img-responsive" alt="" title="" alt="">
							</div>
							<span>User Name</span>
						</div>
					</div>
				</div>
				<div class="rightside" id="chatwindow" data-id="">
					<header class="ctheader">
						<span>EME - Public group chat</span>
					</header>
					<div class="chatwrapper"></div>
					<div class="writewrapper">
						<div class="newcon"></div>
						<div id="istyping"></div>
						<div class="emojiwrapper">
							<ul class="list-inline" id="selectemoji">
								<li class="active" data-id="emoji">
									<i class="fa fa-smile-o"></i>
								</li>
								<li id="skypesticker" data-id="skypewrapper">
									<i class="fa fa-skype"></i>
								</li>
							</ul>
							<div class="emojiwindow">
								<div id="emoji" class="tabwrapper active">
									<div class="emojiicon">
										<img src="img/emoji/1f642.png" data-code=":)" class="img-responsive" />
									</div>
									<div class="emojiicon">
										<img src="img/emoji/2639.png" data-code=":(" class="img-responsive" />
									</div>
									<div class="emojiicon">
										<img src="img/emoji/1f61b.png" data-code=":p" class="img-responsive" />
									</div>
									<div class="emojiicon">
										<img src="img/emoji/1f609.png" data-code=";)" class="img-responsive" />
									</div>
									<div class="emojiicon">
										<img src="img/emoji/1f60e.png" data-code="d)" class="img-responsive" />
									</div>
									<div class="emojiicon">
										<img src="img/emoji/1f627.png" data-code="d:" class="img-responsive" />
									</div>
									<div class="emojiicon">
										<img src="img/emoji/1f62c.png" data-code=":d" class="img-responsive" />
									</div>
									<div class="emojiicon">
										<img src="img/emoji/1f603.png" data-code="=)" class="img-responsive" />
									</div>
									<div class="emojiicon">
										<img src="img/emoji/1f615.png" data-code=":/" class="img-responsive" />
									</div>
								</div>
								<div id="skypewrapper" class="tabwrapper"></div>
							</div>
						</div>
						<div class="formgroup messageForm">
							<div class="wrapwriter">
								<input type="text" name="" placeholder="Enter your message" id="message"  class="form-control">
								<div class="chatoptions">
									<ul class="list-inline">
										<li>
											<i class="fa fa-smile-o" id="emojiicon"></i>
										</li>
										<!-- <li>
											<i class="fa fa-skype" id="emojiiconsky"></i>
										</li> -->
									</ul>
								</div>
							</div>
						</div>
					</div>
				</div>
				<span class="text-right">Developed by <a href="">CPM</a></span>
			</div>
		</div>
		<script>
			var emocode = [];
			var emocode_skype = [];
			var isBrowserTabActive;
			$(window).on("blur focus", function(e) {
			    var prevType = $(this).data("prevType");

			    if (prevType != e.type) {   //  reduce double fire issues
			        switch (e.type) {
			            case "blur":
			                // do work
			                isBrowserTabActive = false;
			                break;
			            case "focus":
			                // do work
			                isBrowserTabActive = true;
			                break;
			        }
			    }

			    $(this).data("prevType", e.type);
			})

			var socket	      		=	io.connect();
			var $message 		  	=	$('#message');
			var $chat	 		    =	$('.chatwrapper');

			var	$messageAre 		=	$('#messageAre');
			var	$userFormAre 		=	$('#userFormAre');
			var	$userForm 	 		=	$('#userForm');
			var	$users  	 		=	$('.onlineuserswrapper');
			var	$username  	 		=	$('#username');
			var	$emojiicon  	 	=	$('#emojiicon');
			var	$emojiwrapper 		=	$('.emojiwrapper');
			var	$emojiicon  	 	=	$('#emojiicon');
			var	$sinrow 			=	$('.sinrow');

			var cookiename 			= 	Cookies.get('name');

			var username;

			// if (annyang) {
			//   // Let's define our first command. First the text we expect, and then the function it should call
			// 	var commands = {
			// 		'open emoji': function() {
			// 	 		$emojiwrapper.toggle();
			// 		},
			// 		'skype': function() {
			// 			$emojiwrapper.show();
			// 			$emojiwrapper.find('i.fa-skype').trigger('click');
			// 		},
			// 		'type that *tags' = typemesg;
			// 	};
			// 	annyang.addCallback('resultMatch', function(userSaid, commandText, phrases) {
			// 	  console.log(userSaid); // sample output: 'hello'
			// 	  //console.log(commandText); // sample output: 'hello (there)'
			// 	  //console.log(phrases); // sample output: ['hello', 'halo', 'yellow', 'polo', 'hello kitty']
			// 	});

			// 	var typemesg(tag) = function(){
			// 		console.log(tag);
			// 	}

			//   // Add our commands to annyang
			//   annyang.addCommands(commands);

			//   // Start listening. You can call this here, or attach this call to an event, button, etc.
			//   annyang.start();
			// }


			// function you can use:
			function getSecondPart(str) {
			    return str.split(':search')[1];
			}

			$emojiicon.on('click', function(e){
				$emojiwrapper.toggle();
			});

			var $emojiiconsky       =   $('#skypesticker');

			$emojiiconsky.on('click', function(e){
			     var skypeicons = {
			        ':_angel' : '/skype/angel.gif',
			        ':_angry':'/skype/angry.gif',
			        ':_bandit':'/skype/bandit.gif',
			        ':_bhangra':'/skype/bhangra.gif',
			        ':_bike':'/skype/bike.gif',
			        ':_blush':'/skype/blush.gif',
			        ':_bow':'/skype/bow.gif',
			        ':_bug':'/skype/bug.gif',
			        ':_bunny':'/skype/bunny.gif',
			        ':_busyday':'/skype/busyday.gif',
			        ':_call':'/skype/call.gif',
			        ':_cat':'/skype/cat.gif',
			        ':_champagne':'/skype/champagne.gif',
			        ':_chappal':'/skype/chappal.gif',
			        ':_clap':'/skype/clap.gif',
			        ':_computerrage':'/skype/computerrage.gif',
			        ':_cool':'/skype/cool.gif',
			        ':_cry':'/skype/cry.gif',
			        ':_cwl':'/skype/cwl.gif',
			        ':_dance':'/skype/dance.gif',
			        ':_discodancer':'/skype/discodancer.gif',
			        ':_disgust':'/skype/disgust.gif',
			        ':_dog':'/skype/dog.gif',
			        ':_doh':'/skype/doh.gif',
			        ':_donkey':'/skype/donkey.gif',
			        ':_donttalktome':'/skype/donttalktome.gif',
			        ':_dream':'/skype/dream.gif',
			        ':_drink':'/skype/drink.gif',
			        ':_drunk':'/skype/drunk.gif',
			        ':_dull':'/skype/dull.gif',
			        ':_eg':'/skype/eg.gif',
			        ':_emo':'/skype/emo.gif',
			        ':_envy':'/skype/envy.gif',
			        ':_ezgif':'/skype/ezgif-3737831102.gif',
			        ':_facepalm':'/skype/facepalm.gif',
			        ':_fallinlove':'/skype/fallinlove.gif',
			        ':_fear':'/skype/fear.gif',
			        ':_fubar':'/skype/fubar.gif',
			        ':_gran':'/skype/gran.gif',
			        ':_handsinair':'/skype/handsinair.gif',
			        ':_headbang':'/skype/headbang.gif',
			        ':_headphones':'/skype/headphones.gif',
			        ':_ladyvampire':'/skype/ladyvampire.gif',
			        ':_lalala':'/skype/lalala.gif',
			        ':_mlt':'/skype/mlt.gif',
			        ':_monkey':'/skype/monkey.gif',
			        ':_movember':'/skype/movember.gif',
			        ':_muscleman':'/skype/muscleman.gif',
			        ':_nahi':'/skype/nahi.gif',
			        ':_naturescall':'/skype/naturescall.gif',
			        ':_nazar':'/skype/nazar.gif',
			        ':_neil':'/skype/neil.gif',
			        ':_nerdy':'/skype/nerdy.gif',
			        ':_ninja':'/skype/ninja.gif',
			        ':_nod':'/skype/nod.gif',
			        ':_ok':'/skype/ok.gif',
			        ':_oliver':'/skype/oliver.gif',
			        ':_ontheloo':'/skype/ontheloo.gif',
			        ':_penguin':'/skype/penguin.gif',
			        ':_pig':'/skype/pig.gif',
			        ':_poke':'/skype/poke.gif',
			        ':_polarbear':'/skype/polarbear.gif',
			        ':_poolparty':'/skype/poolparty.gif',
			        ':_poop':'/skype/poop.gif',
			        ':_praying':'/skype/praying.gif',
			        ':_promise':'/skype/promise.gif',
			        ':_puke':'/skype/puke.gif',
			        ':_pullshot':'/skype/pullshot.gif',
			        ':_pumpkin':'/skype/pumpkin.gif',
			        ':_punch':'/skype/punch.gif',
			        ':_red':'/skype/red.gif',
			        ':_reindeer':'/skype/reindeer.gif',
			        ':_rock':'/skype/rock.gif',
			        ':_rofl':'/skype/rofl.gif',
			        ':_running':'/skype/running.gif',
			        ':_sad':'/skype/sad.gif',
			        ':_santa':'/skype/santa.gif',
			        ':_sksantamooning':'/skype/santamooning.gif',
			        ':_sarcastic':'/skype/sarcastic.gif',
			        ':_selfie':'/skype/selfie.gif',
			        ':_shake':'/skype/shake.gif',
			        ':_sheep':'/skype/sheep.gif',
			        ':_shivering':'/skype/shivering.gif',
			        ':_slap':'/skype/slap.gif',
			        ':_sleepy':'/skype/sleepy.gif',
			        ':_smile':'/skype/smile.gif',
			        ':_smirk':'/skype/smirk.gif',
			        ':_smoke':'/skype/smoke.gif',
			        ':_speechless':'/skype/speechless.gif',
			        ':_surprised':'/skype/surprised.gif',
			        ':_swear':'/skype/swear.gif',
			        ':_sweat':'/skype/sweat.gif',
			        ':_sintalk':'/skype/talk.gif',
			        ':_sintalk':'/skype/talk.gif',
			        ':_talktothehand':'/skype/talktothehand.gif',
			        ':_taur':'/skype/taur.gif',
			        ':_think':'/skype/think.gif',
			        ':_tired':'/skype/tired.gif',
			        ':_tmi':'/skype/tmi.gif',
			        ':_tongueout':'/skype/tongueout.gif',
			        ':_ttm':'/skype/ttm.gif',
			        ':_turkey':'/skype/turkey.gif',
			        ':_sinwait':'/skype/wait.gif',
			        ':_waiting':'/skype/waiting.gif',
			        ':_whew':'/skype/whew.gif',
			        ':_whistle':'/skype/whistle.gif',
			        ':_wink':'/skype/wink.gif',
			        ':_wtf':'/skype/wtf.gif'
			        }

			    var imgUrl = 'img/emoji/skype/sheep.gif';
			    // console.log(skypeicons);
			    var appendhtml = '';
			    for(var i in skypeicons){
			        // skip loop if the property is from prototype
			        if(!skypeicons.hasOwnProperty(i)) continue;
			    	appendhtml += '<div class="emojiicon">'
			    	appendhtml += '<img src="img/emoji/'+skypeicons[i]+'" data-code="'+i+'" class="img-responsive"></div>'
			    	$('#skypewrapper').html(appendhtml);
			    }

			    $('.emojiicon img').click(function(){
			    	var clickedval	=	$(this).attr('data-code');
					$message.val(clickedval).focus();
					$emojiwrapper.toggle();
			    });

			});

			$emojiwrapper.find('img').on('click', function(){
				var clickedval	=	$(this).attr('data-code');
				$message.val(clickedval).focus();
				$emojiwrapper.toggle();
			});

			var myFunction = function() {
			  window.focus();
			};

			var myImg = "https://unsplash.it/600/600?image=777";


			$(function(){
				$message.keypress(function(e){
				  if(e.keyCode == 13){
				    var cleardata = $message.val();
						var sendRedy  = cleardata.replace(/<\/?[^>]+(>|$)/g, "");

						if(sendRedy){
							socket.emit('send message', sendRedy);
							$message.val('');
						}
				  }else{
				  	// IS typing some user
				  	// console.log(socket.id);
				  	socket.emit('is-typing', {username: username});
				  }
				});

				socket.on('new message', function(data){
					var datamessage		=	data.msg;
					var datamessagelower=	datamessage.toLowerCase();
					var soketid			=	data.socket;
					// console.log(soketid);
					htmlemotions = replaceEmotions(datamessagelower);
					var emocode = [':)',';)',':(','>:o',':d',':\'(',':o',':p', 'b)',':x',':s',':$',':*',':/','<3',':&',':>','=d'];
					var emocode_skype = [':_angel',':_angry',':_bandit',':_bhangra',':_bike',':_blush',':_bow',':_bug',':_bunny',':_busyday',':_call',':_cat',':_champagne',':_chappal',':_clap',':_computerrage',':_cool',':_cry',':_cwl',':_dance',':_discodancer',':_disgust',':_dog',':_doh',':_donkey',':_donttalktome',':_dream',':_drink',':_drunk',':_dull',':_eg',':_emo',':_envy',':_facepalm',':_fallinlove',':_fear',':_fubar',':_gran',':_handsinair',':_headbang',':_headphones',':_ladyvampire',':_lalala',':_mlt',':_monkey',':_movember',':_muscleman',':_nahi',':_naturescall',':_nazar',':_neil',':_nerdy',':_ninja',':_nod',':_ok',':_oliver',':_ontheloo',':_penguin',':_pig',':_poke',':_polarbear',':_poolparty',':_poop',':_praying',':_promise',':_puke',':_pullshot',':_pumpkin',':_punch',':_red',':_reindeer',':_rock',':_rofl',':_running',':_sad',':_santa',':_sksantamooning',':_sarcastic',':_selfie',':_shake',':_sheep',':_shivering',':_slap',':_sleepy',':_smile',':_smirk',':_smoke',':_speechless',':_surprised',':_swear',':_sweat',':_sintalk',':_talktothehand',':_taur',':_think',':_tired',':_tmi',':_tongueout',':_ttm',':_turkey',':_sinwait',':_waiting',':_whew',':_whistle',':_wink',':_wtf'];

					if(jQuery.inArray(datamessagelower, emocode_skype) !== -1 || jQuery.inArray(datamessagelower, emocode) !== -1){
				    	classchat	=	'singleemoji';
					}else{
						classchat	=	'emojiwithtext';
					}

					var message = data.msg;

					message 	= replaceEmotions(message);

					var currentdate = new Date();
					var datetime =	 currentdate.getDate() + "/"
					                + (currentdate.getMonth()+1)  + "/"
					                + currentdate.getFullYear() + " @ "
					                + currentdate.getHours() + ":"
					                + currentdate.getMinutes();

					if(data.user !== cookiename){
						var clientmsg 	= '<div class="chatrow '+ classchat +' clientmsg animated zoomIn"><div class="userImg"><img src="img/man.jpg" class="img-responsive" alt="" title="" alt=""></div><div class="chatinfor"><span>'+data.user+'</span><div class="chatarea">'+message+'</div><small><i>'+datetime+'</i></small></div></div>';

						var options = {
						    title:data.user,
						    options: {
						      body: message,
						      icon: myImg,
						      lang: 'en-US',
						      onClick: myFunction
						    }
						  };
						  // console.log(options);
						  if(!isBrowserTabActive)
						  	$("#easyNotify").easyNotify(options);
							// changeTitle();
					}else{
						var clientmsg 	= '<div class="chatrow selfmsg '+ classchat +' animated zoomIn"><div class="chatinfor"><span>'+data.user+'(You)</span><div class="chatarea">'+message+'</div><small><i>'+datetime+'</i></small></div><div class="userImg"><img src="img/man.jpg" class="img-responsive" alt="" title="" alt=""></div></div>';;
					}

					$chat.append(clientmsg);

					$chat.animate({scrollTop:$chat[0].scrollHeight}, 'fast');
				});

				// login with cookie
				
				if(cookiename){
					socket.emit('setlog', cookiename, function(data){
						$userFormAre.hide();
						$messageAre.show();
					});
				}else{
					Cookies.remove('name');
					$userFormAre.show();
					$messageAre.hide();
					$userForm.submit(function(e){
						e.preventDefault();
						username = $username.val();
						if (username == '' || username == ' ') {
							$username.css("border", "1px solid red");
						}else{
							socket.emit('new user', $username.val(), function(data){
								console.log(socket);
								if(data){
									$userFormAre.hide();
									$messageAre.show();
									Cookies.set('name', username);
									Cookies.set('id', socket.socket.sessionid);
									location.reload();
								}
							});
							$username.val('');
						}
					});
				}

				function readURL(input) {
			        if (input.files && input.files[0]) {
			            var reader = new FileReader();
			            
			            reader.onload = function (e) {
			            	console.log(e.target.result);
			                // $('#blah').attr('src', e.target.result);
			            }
			            
			            reader.readAsDataURL(input.files[0]);
			        }
			    }
			    
			    $("#imgInp").change(function(){
			        readURL(this);
			    });


				socket.on('get users', function(data){
					var html 	=	'';
					for (i = 0; i < data.length; i++) {
						// console.log(data);
						html += '<div class="sinrow" onClick="indimsg(this.id)" id="'+data[i].socket+'"><div class="userImg"><img src="img/man.jpg" class="img-responsive" title="'+data[i].username+'" alt="'+data[i].username+'"></div><span>'+data[i].username+'</span></div>';
					}
					$users.html(html);
				});

				socket.on('is-typing-client', function(data){
					// console.log(data);
					if(username !== data.username){
						$('#istyping').show().html('<span class="animated bounceIn">' + data.username + ' is Typing...</span>');
						setTimeout(function(){ $('#istyping').html('').hide(); }, 2000);
					}
				});

				socket.on('get single user', function(data){
					if (data != null) {
						$('.newcon').show().html('<span class="newconnection animated bounceIn">'+data.username+' is now connected with your conversation</span>');
						setTimeout(function(){
							$('.newcon').hide();
						}, 8000);
					}
				});
			});
		</script>
	</body>
</html>
